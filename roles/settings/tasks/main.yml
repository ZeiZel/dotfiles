---

# macOS Settings

- name: Configure macOS settings
  when: ansible_facts['os_family'] == "Darwin"
  block:
    - name: Set keyboard initial key repeat
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: InitialKeyRepeat
        type: float
        value: "{{ macos_initial_key_repeat }}"

    - name: Set keyboard key repeat rate
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: KeyRepeat
        type: float
        value: "{{ macos_key_repeat }}"

    - name: Disable desktop icons
      community.general.osx_defaults:
        domain: com.apple.finder
        key: CreateDesktop
        type: bool
        value: false
      when: macos_disable_desktop_icons

    - name: Show hidden files in Finder
      community.general.osx_defaults:
        domain: com.apple.finder
        key: AppleShowAllFiles
        type: bool
        value: true

    - name: Show file extensions
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: AppleShowAllExtensions
        type: bool
        value: true

    - name: Auto-hide Dock
      community.general.osx_defaults:
        domain: com.apple.dock
        key: autohide
        type: bool
        value: true

    - name: Set Dock autohide delay to 0
      community.general.osx_defaults:
        domain: com.apple.dock
        key: autohide-delay
        type: float
        value: 0

    - name: Enable tap to click
      community.general.osx_defaults:
        domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
        key: Clicking
        type: int
        value: 1

    - name: Add Homebrew to /etc/zshenv
      become: true
      ansible.builtin.lineinfile:
        path: /etc/zshenv
        line: 'eval "$(/opt/homebrew/bin/brew shellenv)"'
        create: true
        mode: "0644"

# Linux Settings

- name: Configure Linux settings
  when: ansible_facts['os_family'] != "Darwin"
  block:
    - name: Add Homebrew to .bashrc
      ansible.builtin.blockinfile:
        path: "{{ dotfiles_home }}/.bashrc"
        create: true
        mode: "0644"
        marker: "# {mark} ANSIBLE - Homebrew"
        block: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

    - name: Add Homebrew to .zprofile
      ansible.builtin.blockinfile:
        path: "{{ dotfiles_home }}/.zprofile"
        create: true
        mode: "0644"
        marker: "# {mark} ANSIBLE - Homebrew"
        block: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

    - name: Create Xorg config directory
      become: true
      ansible.builtin.file:
        path: /etc/X11/xorg.conf.d
        state: directory
        mode: "0755"
      failed_when: false

    - name: Create keyboard configuration for X11
      become: true
      ansible.builtin.copy:
        dest: /etc/X11/xorg.conf.d/00-keyboard.conf
        mode: "0644"
        content: |
          Section "InputClass"
              Identifier "system-keyboard"
              MatchIsKeyboard "on"
              Option "AutoRepeat" "{{ linux_key_repeat_delay }} {{ linux_key_repeat_rate }}"
          EndSection
      failed_when: false

    - name: Check if gsettings is available
      ansible.builtin.command:
        cmd: which gsettings
      register: gsettings_check
      failed_when: false
      changed_when: false

    - name: Set keyboard repeat delay (GNOME)
      ansible.builtin.command:
        cmd: "gsettings set org.gnome.desktop.peripherals.keyboard delay {{ linux_key_repeat_delay }}"
      when: gsettings_check.rc == 0
      failed_when: false
      changed_when: false

    - name: Set keyboard repeat interval (GNOME)
      ansible.builtin.command:
        cmd: "gsettings set org.gnome.desktop.peripherals.keyboard repeat-interval {{ (1000 / linux_key_repeat_rate) | int }}"
      when: gsettings_check.rc == 0
      failed_when: false
      changed_when: false

    - name: Check if kwriteconfig5 is available
      ansible.builtin.command:
        cmd: which kwriteconfig5
      register: kwriteconfig_check
      failed_when: false
      changed_when: false

    - name: Set keyboard repeat delay (KDE)
      ansible.builtin.command:
        cmd: "kwriteconfig5 --file kcminputrc --group Keyboard --key RepeatDelay {{ linux_key_repeat_delay }}"
      when: kwriteconfig_check.rc == 0
      failed_when: false
      changed_when: false

    - name: Set keyboard repeat rate (KDE)
      ansible.builtin.command:
        cmd: "kwriteconfig5 --file kcminputrc --group Keyboard --key RepeatRate {{ linux_key_repeat_rate }}"
      when: kwriteconfig_check.rc == 0
      failed_when: false
      changed_when: false

    - name: Get zsh path
      ansible.builtin.command:
        cmd: which zsh
      register: zsh_path
      changed_when: false
      environment:
        PATH: "{{ homebrew_bin }}:{{ ansible_env.PATH }}"

    - name: Ensure zsh is in /etc/shells
      become: true
      ansible.builtin.lineinfile:
        path: /etc/shells
        line: "{{ zsh_path.stdout }}"
        state: present

    - name: Change default shell to zsh
      become: true
      ansible.builtin.user:
        name: "{{ dotfiles_user }}"
        shell: "{{ zsh_path.stdout }}"
