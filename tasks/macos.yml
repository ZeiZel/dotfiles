---
- name: Check if Homebrew is installed (macOS ARM)
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: homebrew_arm
- name: Check if Homebrew is installed (macOS Intel)
  ansible.builtin.stat:
    path: /usr/local/bin/brew
  register: homebrew_intel
- name: Install Homebrew (macOS)
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    executable: /bin/bash
  changed_when: true
  when:
    - not (homebrew_arm.stat.exists | default(false))
    - not (homebrew_intel.stat.exists | default(false))
- name: Configure macOS settings
  block:
    - name: Set keyboard initial key repeat
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: InitialKeyRepeat
        type: float
        value: '{{ macos_initial_key_repeat }}'
        check_type: false
    - name: Set keyboard key repeat rate
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: KeyRepeat
        type: float
        value: '{{ macos_key_repeat }}'
        check_type: false
    - name: Disable desktop icons
      community.general.osx_defaults:
        domain: com.apple.finder
        key: CreateDesktop
        type: bool
        value: false
        check_type: false
      when: macos_disable_desktop_icons
    - name: Show hidden files in Finder
      community.general.osx_defaults:
        domain: com.apple.finder
        key: AppleShowAllFiles
        type: bool
        value: true
        check_type: false
    - name: Show file extensions
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: AppleShowAllExtensions
        type: bool
        value: true
        check_type: false
    - name: Auto-hide Dock
      community.general.osx_defaults:
        domain: com.apple.dock
        key: autohide
        type: bool
        value: true
        check_type: false
    - name: Set Dock autohide delay to 0
      community.general.osx_defaults:
        domain: com.apple.dock
        key: autohide-delay
        type: float
        value: 0
        check_type: false
    - name: Enable tap to click
      community.general.osx_defaults:
        domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
        key: Clicking
        type: int
        value: 1
        check_type: false
